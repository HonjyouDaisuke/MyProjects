<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8" />
	<title>サンプル</title>
	<!-- Bootstrap用CSSの読み込み -->
	<!-- Bootstrap用JavaScriptの読み込み -->
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.3.1/fabric.min.js" integrity="sha512-ACqMrfAtm537AWzgx/xQ57JnFxXeq8RylQMGg4y/e6M2ew4Z8NycE8aId/Bt2ZE+w1gNsox3MgwxKl7SGMRdtA==" crossorigin="anonymous"></script>
	<style>
		.canvas-wrapper{
			position: relative;
		}
		.canvas-wrapper canvas{
			position: absolute;
			top: 0;
			left: 0;
		}
	</style>
  <script>
    function LoadImageFile(files, canvasName) {        　
        var canvas = document.getElementById(canvasName);
		var canvas_tmp = document.getElementById("tmp"); 
        var ctx = canvas.getContext('2d');          　
        var reader = new FileReader();              
        reader.onload = function(event) {           
            var img = new Image();                 
            img.onload = function() {              
                canvas.width = img.naturalWidth;
				canvas.height = img.naturalHeight; 
				canvas_tmp.width = img.naturalWidth;
				canvas_tmp.height = img.naturalHeight
                //canvas.style.width = canvas.width + "px";
				//canvas.style.height = canvas.height + "px";    
				ctx.drawImage(img, 0, 0); 
				console.log(canvas.style.width + "," + canvas.style.height + ":" + canvas.width + "," + canvas.height);
            }                                     　
            img.src = event.target.result;  
            canvas.isDrawingMode = true;　      　
        }                                           
        reader.readAsDataURL(files[0]);             　　
    }

	function SizeChange(canvasName){
		var canvas = document.getElementById(canvasName);
		canvas.width = 700;
		canvas.height = 500;
		alert(canvasName);
	}

	function TestPixcel(canvasName){
		var canvas = new fabric.Canvas(canvasName);
		var canvas2 = new fabric.Canvas("tmp");
		var cc = canvas.getContext('2d');
		var cc2 = canvas2.getContext('2d');

		var top = 0;
		var left = 0;
		var width = 255;
		var height = 255;
		var ImageData = cc.getImageData(top, left, width, height);
		var data = ImageData;
		for (var x = 0; x < width; ++x) {
			for (var y = 0; y < height; ++y) {
				// 対象pixelのindex（色情報があるので*4する） 
				var index = (x + y * width) * 4;
				data[index + 0] = x;
				data[index + 1] = y;
				data[index + 2] = (x + y) / 255;
				data[index + 3] = 255;
			};
		};
		ImageData.data = data;
		var fabricImage = new fabric.Image(ImageData);
		canvas2.add(fabricImage);
		cc2.putImageData(ImageData, top, left);
	}

	function TestPixcel2(canvasName){
		var canvas = new fabric.Canvas(canvasName);
		var canvas2 = new fabric.Canvas("tmp");
		var ctx = canvas.getContext('2d');
		var data = ctx.getImageData(0, 0, 200, 200);

		var c = document.createElement('canvas');

		c.setAttribute('id', '_temp_canvas');
		c.width = 20;
		c.height = 20;

		c.getContext('2d').putImageData(data, 0, 0);
		console.log(c.toDataURL());
		fabric.Image.fromURL(c.toDataURL(), function(img) {
			img.left = 50;
			img.top = 50;
			canvas2.add(img);
			console.log(img.left);
			img.bringToFront();
			c = null;
			$('#_temp_canvas').remove();
			canvas2.renderAll();
			
		});
	}

    var mamDraw=[];
    mamDraw.isMouseDown=false;
    mamDraw.position=[];
    mamDraw.position.x=0;
    mamDraw.position.y=0;
    mamDraw.position.px=0;
    mamDraw.position.py=0;

	let pointX = [];
	let pointY = [];

    window.addEventListener("load",function(){
        //初期設定
        mamDraw.canvas=document.getElementById("tmp");
        mamDraw.canvas.addEventListener("touchstart",onDown);
        mamDraw.canvas.addEventListener("touchmove",onMove);
        mamDraw.canvas.addEventListener("touchend",onUp);
        mamDraw.canvas.addEventListener("mousedown",onMouseDown);
        mamDraw.canvas.addEventListener("mousemove",onMouseMove);
        mamDraw.canvas.addEventListener("mouseup",onMouseUp);
        window.addEventListener("mousemove",StopShake);
        mamDraw.context=mamDraw.canvas.getContext("2d");
        mamDraw.context.strokeStyle="#000000";
        mamDraw.context.lineWidth=5;
        mamDraw.context.lineJoin="round";
        mamDraw.context.lineCap="round";
        //document.getElementById("clearCanvas").addEventListener("click",clearCanvas);
    });
    function StopShake(event){
        mamDraw.isMouseDown=false;
        event.stopPropagation();
    }
    function onDown(event){
        mamDraw.isMouseDown=true;
        mamDraw.position.px=event.touches[0].pageX-event.target.getBoundingClientRect().left-mamGetScrollPosition().x;
        mamDraw.position.py=event.touches[0].pageY-event.target.getBoundingClientRect().top -mamGetScrollPosition().y;
        mamDraw.position.x=mamDraw.position.px;
        mamDraw.position.y=mamDraw.position.py;
		pointX.push(mamDraw.position.x);
		pointY.push(mamDraw.position.y);
        drawLine();
        event.preventDefault();
        event.stopPropagation();
    }
    function onMove(event){
        if(mamDraw.isMouseDown){
			mamDraw.position.x=event.touches[0].pageX-event.target.getBoundingClientRect().left-mamGetScrollPosition().x;
			mamDraw.position.y=event.touches[0].pageY-event.target.getBoundingClientRect().top -mamGetScrollPosition().y;
			drawLine();
			mamDraw.position.px=mamDraw.position.x;
			mamDraw.position.py=mamDraw.position.y;
			pointX.push(mamDraw.position.x);
			pointY.push(mamDraw.position.y);
        
			event.stopPropagation();
        }
    }
    function onUp(event){
        mamDraw.isMouseDown=false;
        fillPath();
		pointX = [];
		pointY = [];

        event.stopPropagation();
    }
    function onMouseDown(event){
        mamDraw.position.px=event.clientX-event.target.getBoundingClientRect().left;
        mamDraw.position.py=event.clientY-event.target.getBoundingClientRect().top ;
        mamDraw.position.x=mamDraw.position.px;
        mamDraw.position.y=mamDraw.position.py;
        pointX.push(mamDraw.position.x);
		pointY.push(mamDraw.position.y);
        drawLine();
        mamDraw.isMouseDown=true;
        event.stopPropagation();
    }
    function onMouseMove(event){
        if(mamDraw.isMouseDown){
			mamDraw.position.x=event.clientX-event.target.getBoundingClientRect().left;
			mamDraw.position.y=event.clientY-event.target.getBoundingClientRect().top ;
			pointX.push(mamDraw.position.x);
			pointY.push(mamDraw.position.y);
			drawLine();
			mamDraw.position.px=mamDraw.position.x;
			mamDraw.position.py=mamDraw.position.y;
			event.stopPropagation();
        }
    }
    function onMouseUp(event){
        mamDraw.isMouseDown=false;
		fillPath();
		pointX = [];
		pointY = [];

        event.stopPropagation();
    }
    function drawLine(){
        mamDraw.context.strokeStyle="#000000";
        mamDraw.context.lineWidth=5;
        mamDraw.context.lineJoin="round";
        mamDraw.context.lineCap="round";
        mamDraw.context.beginPath();
        mamDraw.context.moveTo(mamDraw.position.px,mamDraw.position.py);
        mamDraw.context.lineTo(mamDraw.position.x,mamDraw.position.y);
        mamDraw.context.stroke();
    }
	function fillPath(){
		mamDraw.context.beginPath();
		mamDraw.context.moveTo(pointX[0], pointY[0]);
		for(i=1; i<pointX.length; i++){
			mamDraw.context.lineTo(pointX[i], pointY[i]);
		}
		mamDraw.context.closePath();
		mamDraw.context.fillStyle = 'rgb(0, 0, 255)';
		mamDraw.context.fill();
	}
    function clearCanvas(){
        //mamDraw.context.fillStyle="rgb(255,255,255)";
        mamDraw.context.clearRect(
			0,0,
			mamDraw.canvas.getBoundingClientRect().width,
			mamDraw.canvas.getBoundingClientRect().height
        );
    }
    function mamGetScrollPosition() {
        return {
        "x":document.documentElement.scrollLeft || document.body.scrollLeft,
        "y":document.documentElement.scrollTop  || document.body.scrollTop
        };
    }
    </script>
    
</head>
<body>
  <!-- メインメニュー -->
		<nav class="navbar">
				<div class="container-fluid">
						<div class="navbar-header"> <a class="navbar-brand" href="#">Bootstrap3 チュートリアル</a> </div>
						<ul class="nav navbar-nav">
								<li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">ファイル<span class="caret"></span></a>
                	<ul class="dropdown-menu">
                    <li><a href="#">新しい資料を作成</a></li>
                    <li><a href="javascript:LoadImageFile('cnvs');">
						<label>
							画像を読み込む
							<input type="file" id="file" style="display: none;" onchange="LoadImageFile(this.files, 'cnvs')">
						</label>
						
					</a></li>
					<li><a href="javascript:clearCanvas();">
						<label>
							画像をぼかす？？
						</label>
					</a></li>
                    <li><a href="javascript:SizeChange('cnvs');">閉じる</a></li>
                    <li><a href="#">終了</a></li>
                  </ul>
                </li>

								<li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="#">Page 1<span class="caret"></span></a>
									<ul class="dropdown-menu">
											<li><a href="#">Page 1-1</a></li>
											<li><a href="#">Page 1-2</a></li>
											<li><a href="#">Page 1-3</a></li>
									</ul>
								</li>
								<li><a href="#">Page 1</a></li>
								<li><a href="#">Page 2</a></li>
								<li><a href="#">Page 3</a></li>
						</ul>
				</div>
		</nav>
		<main class="p-3">
				<div class="row">
						<nav class="col-sm-1">
								<ul class="nav nav-pills nav-stacked nav-inverse" data-spy="affix" data-offset-top="205">
										<li class="active"><a href="#section1">セクション 1</a></li>
										<li><a href="#section2">セクション 2</a></li>
										<li><a href="#section3">セクション 3</a></li>
								</ul>
						</nav>
						<div class="col-sm-8">
								<ul class="nav nav-tabs nav-inverse">
										<li class="nav-item"> <a href="#photo1" class="nav-link active" data-toggle="tab">タブ１</a> </li>
										<li class="nav-item"> <a href="#photo2" class="nav-link" data-toggle="tab">タブ2</a> </li>
										<li class="nav-item"> <a href="#photo3" class="nav-link" data-toggle="tab">タブ3</a> </li>
										<li class="nav-item"> <a href="#photo4" class="nav-link" data-toggle="tab">タブ4</a> </li>
								</ul>
								<!-- 写真部分 -->
								<div class="tab-content">
									<div class="canvas-wrapper">
										<canvas id="cnvs" style="border:1px solid #aaa" class="img-fluid"></canvas>
										<canvas id="tmp" style="border:1px solid #aaa" class="img-fluid"></canvas>
									</div>	
												
										<div id="photo2" class="tab-pane"> タブコントロールです。リポジトリチェック </div>
										<div id="photo3" class="tab-pane"> こちらも変えてみます。 </div>
										<div id="photo4" class="tab-pane"> ここには写真４が入ります。 </div>
								</div>
						</div>
						<div class="col-sm-3"> ここに右サイドバーメニューを出します。 <br>たくさん書きます<br>たくさん書きます<br>たくさん書きます<br>たくさん書きます<br>たくさん書きます<br></div>
				</div>
				<!-- 4個分のタブ -->
		</main>
</body>
</html>