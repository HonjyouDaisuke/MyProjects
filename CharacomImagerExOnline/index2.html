<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8" />
	<title>サンプル</title>
	<!-- Bootstrap用CSSの読み込み -->
	<!-- Bootstrap用JavaScriptの読み込み -->
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.3.1/fabric.min.js" integrity="sha512-ACqMrfAtm537AWzgx/xQ57JnFxXeq8RylQMGg4y/e6M2ew4Z8NycE8aId/Bt2ZE+w1gNsox3MgwxKl7SGMRdtA==" crossorigin="anonymous"></script>
	<style>
		.canvas-wrapper{
			position: relative;
		}
		.canvas-wrapper canvas{
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			overflow: auto;
		}
	</style>
  <script>
    function LoadImageFile(files, canvasName) {        　
        var canvas = document.getElementById(canvasName);
		var canvas_tmp = document.getElementById("tmp"); 
		var canvas_Rect = document.getElementById("ex_rect");
        var ctx = canvas.getContext('2d');          　
        var reader = new FileReader();              
        reader.onload = function(event) {           
            var img = new Image();                 
            img.onload = function() {              
                canvas.width = img.naturalWidth;
				canvas.height = img.naturalHeight; 
				canvas_tmp.width = img.naturalWidth;
				canvas_tmp.height = img.naturalHeight;
				canvas_Rect.width = img.naturalWidth;
				canvas_Rect.height = img.naturalHeight;
                //canvas.style.width = canvas.width + "px";
				//canvas.style.height = canvas.height + "px";    
				ctx.drawImage(img, 0, 0); 
				console.log(canvas.style.width + "," + canvas.style.height + ":" + canvas.width + "," + canvas.height);
            }                                     　
            img.src = event.target.result;  
            canvas.isDrawingMode = true;　      　
        }                                           
        reader.readAsDataURL(files[0]);             　　
    }

	function SizeChange(canvasName){
		var canvas = document.getElementById(canvasName);
		canvas.width = 700;
		canvas.height = 500;
		alert(canvasName);
	}

	// Rectangle
	function struct(func) {
		return function() {
			var f = new func();
			func.apply(f, arguments); // (C)
			return f;
		}; // (B)
	}

	var Rect = struct(function Rect(x, y, width, height) {
		this.x = x;
		this.y = y;
		this.width = width;
		this.height = height;
	});

	function getRectangle(){
		var r = new Rect(0, 0, 0, 0);
		max_x = 0;
		min_x = 9999999;
		max_y = 0;
		min_y = 9999999;

		for(i=0; i<pointX.length; i++){
			if(pointX[i] > max_x) max_x = pointX[i];
			if(pointX[i] < min_x) min_x = pointX[i];
		}
		for(i=0; i<pointX.length; i++){
			if(pointY[i] > max_y) max_y = pointY[i];
			if(pointY[i] < min_y) min_y = pointY[i];
		}
		r.x = min_x;
		r.y = min_y;
		r.width = max_x - min_x;
		r.height = max_y - min_y;

		return r;
	}

	function GetRactangleImage(originalCanvas, extractionCanvas, rectCanvas,rect){
		var ocContext = originalCanvas.getContext('2d');
		var exContext = extractionCanvas.getContext('2d');
		var moContext = originalCanvas.getContext('2d');
		var reContext = rectCanvas.getContext('2d');
		var ocImage = ocContext.getImageData(rect.x, rect.y, rect.width, rect.height);
		var exImage = exContext.getImageData(rect.x, rect.y, rect.width, rect.height);
		var moImage = moContext.getImageData(rect.x, rect.y, rect.width, rect.height);
		
		BinarizationImage(moImage);
		var outImage = CompRectImage(ocImage, exImage, moImage, ocImage.width, ocImage.height);
		drawRect(rectCanvas, reContext, rect);
		clearCanvas(extractionCanvas);
		var sideCanvasID = CreateCanvas();
		var canvas_tmp = document.getElementById(sideCanvasID); 
        var ctx_tmp = canvas_tmp.getContext('2d');
		canvas_tmp.height = outImage.height;
		canvas_tmp.width = outImage.width;
		ctx_tmp.putImageData(outImage, 0, 0);       
	}

	//2値化処理
	function BinarizationImage(ImageData){
		//モノクロ変換
		for( i=0; i<ImageData.height; i++){
			for(j=0; j<ImageData.width; j++){
				var index = (j + i * ImageData.width) * 4;
				var R = ImageData.data[index + 0];
				var G = ImageData.data[index + 1];
				var B = ImageData.data[index + 2];
				var A = ImageData.data[index + 3];

				ImageData.data[index + 0] = 0.30*R + 0.59*G + 0.11*B;
				ImageData.data[index + 1] = 0.30*R + 0.59*G + 0.11*B;
				ImageData.data[index + 2] = 0.30*R + 0.59*G + 0.11*B;
			}
		}

		//判別分析
		var sb2_max = 0;
		for (t_num = 0; t_num < 256; t_num++){
			var sb2 = 0.0;
			var w0 = 0.0;
			var w1 = 0.0;
			var m0 = 0.0;
			var m1 = 0.0;
			var class0 = 0;
			var class1 = 0;
			var sum0 = 0;
			var sum1 = 0;
			var ave0 = 0;
			var ave1 = 0;
			for( i = 0; i < ImageData.height; i ++){
				for( j = 0; j < ImageData.width; j ++){
					var index = (j + i * ImageData.width) * 4;
					if(ImageData.data[index + 0] < t_num){
						sum0 += ImageData.data[index + 0];
						class0 ++;
					}else{
						sum1 += ImageData.data[index + 0];
						class1 ++;
					}
				}
			}
			w0 = class0/(ImageData.width * ImageData.height);
			w1 = class1/(ImageData.width * ImageData.height);
			if(class0 == 0){
				m0 = 0;
			}else{
				m0 = sum0/class0;
			}
			if(class1 == 0){
				m1 = 0;
			}else{
				m1 = sum1/class1;
			}
			sb2 = w0 * w1 * (m0 - m1) * (m0 - m1);
			if(sb2 > sb2_max){
				sb2_max = sb2;
				t = t_num;
			}
		}

		for( i=0; i<ImageData.height; i++){
			for(j=0; j<ImageData.width; j++){
				var index = (j + i * ImageData.width) * 4;
				var R = ImageData.data[index + 0];
				var a;
				if(R < t){
					a = 0;
				}else{
					a = 255;
				}
				ImageData.data[index + 0] = a;
				ImageData.data[index + 1] = a;
				ImageData.data[index + 2] = a;
			}
		}
		 　
	}
	
	//矩形、モノクロ画像を作り、文字を抽出
	function CompRectImage(ocImage, exImage, moImage, width, height){
		var outImage = new ImageData(width, height);

		for( i=0; i<ocImage.height; i++){
			for(j=0; j<ocImage.width; j++){
				var index = (j + i * width) * 4;
				var ocR = ocImage.data[index + 0];
				var ocG = ocImage.data[index + 1];
				var ocB = ocImage.data[index + 2];
				var ocA = ocImage.data[index + 3];
				var exR = exImage.data[index + 0];
				var exG = exImage.data[index + 1];
				var exB = exImage.data[index + 2];
				var moB = moImage.data[index + 0];

				if(exB > 250 && moB == 0){
					outImage.data[index + 0] = ocR;
					outImage.data[index + 1] = ocG;
					outImage.data[index + 2] = ocB;
					outImage.data[index + 3] = ocA;
				}
			}
		}

		return(outImage);
//		var canvas_tmp = document.getElementById("chara"); 
//        var ctx_tmp = canvas_tmp.getContext('2d');
//		canvas_tmp.height = outImage.height;
//		canvas_tmp.width = outImage.width;
//		ctx_tmp.putImageData(outImage, 0, 0);       
		   　
	}
	
    var mamDraw=[];
    mamDraw.isMouseDown=false;
    mamDraw.position=[];
    mamDraw.position.x=0;
    mamDraw.position.y=0;
    mamDraw.position.px=0;
    mamDraw.position.py=0;

	let pointX = [];
	let pointY = [];

	var SideBarNum = 0;
    window.addEventListener("load",function(){
        //初期設定
        mamDraw.canvas=document.getElementById("tmp");
        mamDraw.canvas.addEventListener("touchstart",onDown);
        mamDraw.canvas.addEventListener("touchmove",onMove);
        mamDraw.canvas.addEventListener("touchend",onUp);
        mamDraw.canvas.addEventListener("mousedown",onMouseDown);
        mamDraw.canvas.addEventListener("mousemove",onMouseMove);
        mamDraw.canvas.addEventListener("mouseup",onMouseUp);
        window.addEventListener("mousemove",StopShake);
        mamDraw.context=mamDraw.canvas.getContext("2d");
        mamDraw.context.strokeStyle="#000000";
        mamDraw.context.lineWidth=5;
        mamDraw.context.lineJoin="round";
        mamDraw.context.lineCap="round";
        //document.getElementById("clearCanvas").addEventListener("click",clearCanvas);
    });
    function StopShake(event){
        mamDraw.isMouseDown=false;
        event.stopPropagation();
    }
    function onDown(event){
        mamDraw.isMouseDown=true;
		var scaleWidth = mamDraw.canvas.clientWidth / mamDraw.canvas.width;
		var scaleHeight = mamDraw.canvas.clientHeight/ mamDraw.canvas.height;
		console.log("scale===" + scaleWidth + "," + scaleHeight);
        mamDraw.position.px=event.touches[0].pageX-event.target.getBoundingClientRect().left-mamGetScrollPosition().x;
        mamDraw.position.py=event.touches[0].pageY-event.target.getBoundingClientRect().top -mamGetScrollPosition().y;
        mamDraw.position.x=mamDraw.position.px;
        mamDraw.position.y=mamDraw.position.py;
		pointX.push(mamDraw.position.x);
		pointY.push(mamDraw.position.y);
        drawLine();
        event.preventDefault();
        event.stopPropagation();
    }
    function onMove(event){
        if(mamDraw.isMouseDown){
			mamDraw.position.x=event.touches[0].pageX-event.target.getBoundingClientRect().left-mamGetScrollPosition().x;
			mamDraw.position.y=event.touches[0].pageY-event.target.getBoundingClientRect().top -mamGetScrollPosition().y;
			drawLine();
			mamDraw.position.px=mamDraw.position.x;
			mamDraw.position.py=mamDraw.position.y;
			pointX.push(mamDraw.position.x);
			pointY.push(mamDraw.position.y);
        
			event.stopPropagation();
        }
    }
    function onUp(event){
        mamDraw.isMouseDown=false;
        fillPath();
		pointX = [];
		pointY = [];

        event.stopPropagation();
    }
    function onMouseDown(event){
        var scaleWidth = mamDraw.canvas.clientWidth / mamDraw.canvas.width;
		var scaleHeight = mamDraw.canvas.clientHeight/ mamDraw.canvas.height;
		mamDraw.position.px=(event.clientX-event.target.getBoundingClientRect().left)/scaleWidth;
        mamDraw.position.py=(event.clientY-event.target.getBoundingClientRect().top)/scaleHeight;
        if(mamDraw.isMouseDown == true) drawLine();
        mamDraw.position.x=mamDraw.position.px;
        mamDraw.position.y=mamDraw.position.py;
        pointX.push(mamDraw.position.x);
		pointY.push(mamDraw.position.y);
        mamDraw.isMouseDown=true;
        event.stopPropagation();
    }
    function onMouseMove(event){
        if(mamDraw.isMouseDown){
			var scaleWidth = mamDraw.canvas.clientWidth / mamDraw.canvas.width;
			var scaleHeight = mamDraw.canvas.clientHeight/ mamDraw.canvas.height;
			mamDraw.position.px=(event.clientX-event.target.getBoundingClientRect().left)/scaleWidth;
        	mamDraw.position.py=(event.clientY-event.target.getBoundingClientRect().top)/scaleHeight;
        	drawLine();
			mamDraw.position.x=mamDraw.position.px;
        	mamDraw.position.y=mamDraw.position.py;
        	pointX.push(mamDraw.position.x);
			pointY.push(mamDraw.position.y);
			mamDraw.position.px=mamDraw.position.x;
			mamDraw.position.py=mamDraw.position.y;
			event.stopPropagation();
        }
    }
    function onMouseUp(event){
        mamDraw.isMouseDown=false;
		fillPath();
		var rect = getRectangle();
		console.log(rect);
        var canvas = document.getElementById('cnvs');
		var rect_canvas = document.getElementById('ex_rect');
		GetRactangleImage(canvas, mamDraw.canvas, rect_canvas, rect);
		pointX = [];
		pointY = [];
		event.stopPropagation();
    }
    function drawLine(){
        var scaleWidth = mamDraw.canvas.clientWidth / mamDraw.canvas.width;
		var scaleHeight = mamDraw.canvas.clientHeight/ mamDraw.canvas.height;
		mamDraw.context.strokeStyle="#000000";
		mamDraw.context.setLineDash([2, 2]);
        mamDraw.context.lineWidth=2 / scaleWidth;
        mamDraw.context.lineJoin="round";
        mamDraw.context.lineCap="round";
        mamDraw.context.beginPath();
        mamDraw.context.moveTo(mamDraw.position.px,mamDraw.position.py);
        mamDraw.context.lineTo(mamDraw.position.x,mamDraw.position.y);
        mamDraw.context.stroke();
    }

	// Create Canvas
	function CreateCanvas(){
		var new_canvas = document.createElement('canvas');
		var strCanvasID = "new_canvas" + SideBarNum.toString();
		new_canvas.id = strCanvasID;
		new_canvas.style.width = "100%";
		var side_bar = document.getElementById('rightSide');
		side_bar.appendChild(new_canvas);
		SideBarNum++;
		return(strCanvasID);
	}

	function drawRect(rectCanvas, rectContext, rect){
        var scaleWidth = rectCanvas.clientWidth / rectCanvas.width;
		var scaleHeight = rectCanvas.clientHeight/ rectCanvas.height;
		rectContext.strokeStyle="red";
		rectContext.setLineDash([5 / scaleWidth, 5 / scaleWidth]);
        rectContext.lineWidth=2 / scaleWidth;
        rectContext.lineJoin="round";
        rectContext.lineCap="round";
        rectContext.beginPath();
        
		rectContext.rect(rect.x, rect.y, rect.width, rect.height);

		rectContext.stroke();
		console.log("aaaa");
    }

	function clearCanvas(canvas)
	{
		var ctx = canvas.getContext("2d");
		ctx.clearRect(0, 0, canvas.width, canvas.height);
	}

	function fillPath(){
		mamDraw.context.beginPath();
		mamDraw.context.moveTo(pointX[0], pointY[0]);
		for(i=1; i<pointX.length; i++){
			mamDraw.context.lineTo(pointX[i], pointY[i]);
		}
		mamDraw.context.closePath();
		mamDraw.context.fillStyle = 'rgb(0, 0, 255)';
		mamDraw.context.fill();
	}
	/***
    function clearCanvas(){
        //mamDraw.context.fillStyle="rgb(255,255,255)";
        mamDraw.context.clearRect(
			0,0,
			mamDraw.canvas.getBoundingClientRect().width,
			mamDraw.canvas.getBoundingClientRect().height
        );
    }
	***/
    function mamGetScrollPosition() {
        return {
        "x":document.documentElement.scrollLeft || document.body.scrollLeft,
        "y":document.documentElement.scrollTop  || document.body.scrollTop
        };
    }
    </script>
    
</head>
<body>
  <!-- メインメニュー -->
		<nav class="navbar">
				<div class="container-fluid">
						<div class="navbar-header"> <a class="navbar-brand" href="#">Bootstrap3 チュートリアル</a> </div>
						<ul class="nav navbar-nav">
								<li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">ファイル<span class="caret"></span></a>
                	<ul class="dropdown-menu">
                    <li><a href="#">新しい資料を作成</a></li>
                    <li><a href="javascript:LoadImageFile('cnvs');">
						<label>
							画像を読み込む
							<input type="file" id="file" style="display: none;" onchange="LoadImageFile(this.files, 'cnvs')">
						</label>
						
					</a></li>
					<li><a href="javascript:CreateCanvas();">
						<label>
							画像をぼかす？？
						</label>
					</a></li>
                    <li><a href="javascript:SizeChange('cnvs');">閉じる</a></li>
                    <li><a href="#">終了</a></li>
                  </ul>
                </li>

								<li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="#">Page 1<span class="caret"></span></a>
									<ul class="dropdown-menu">
											<li><a href="#">Page 1-1</a></li>
											<li><a href="#">Page 1-2</a></li>
											<li><a href="#">Page 1-3</a></li>
									</ul>
								</li>
								<li><a href="#">Page 1</a></li>
								<li><a href="#">Page 2</a></li>
								<li><a href="#">Page 3</a></li>
						</ul>
				</div>
		</nav>
		<main class="p-3">
				<div class="row">
						<nav class="col-sm-1">
								<ul class="nav nav-pills nav-stacked nav-inverse" data-spy="affix" data-offset-top="205">
										<li class="active"><a href="#section1">セクション 1</a></li>
										<li><a href="#section2">セクション 2</a></li>
										<li><a href="#section3">セクション 3</a></li>
								</ul>
						</nav>
						<div class="col-sm-8">
								<ul class="nav nav-tabs nav-inverse">
										<li class="nav-item"> <a href="#photo1" class="nav-link active" data-toggle="tab">タブ１</a> </li>
										<li class="nav-item"> <a href="#photo2" class="nav-link" data-toggle="tab">タブ2</a> </li>
										<li class="nav-item"> <a href="#photo3" class="nav-link" data-toggle="tab">タブ3</a> </li>
										<li class="nav-item"> <a href="#photo4" class="nav-link" data-toggle="tab">タブ4</a> </li>
								</ul>
								<!-- 写真部分 -->
								<div class="tab-content">
									<div class="canvas-wrapper">
										<canvas id="cnvs" style="border:1px solid #aaa" class="img-fluid"></canvas>
										<canvas id="ex_rect" style="border:1px solid #aaa" class="img-fluid"></canvas>
										<canvas id="tmp" style="border:1px solid #aaa" class="img-fluid"></canvas>
										
									</div>	
												
										<div id="photo2" class="tab-pane"> タブコントロールです。リポジトリチェック </div>
										<div id="photo3" class="tab-pane"> こちらも変えてみます。 </div>
										<div id="photo4" class="tab-pane"> ここには写真４が入ります。 </div>
								</div>
						</div>
						<div id='rightSide' class="col-sm-3">
							<canvas id="chara" style="border:1px solid #aaa" class="img-fluid"></canvas>
							<br>
							ここに右サイドバーメニューを出します。 <br>たくさん書きます<br>たくさん書きます<br>たくさん書きます<br>たくさん書きます<br>たくさん書きます<br>
						</div>
				</div>
				<!-- 4個分のタブ -->
		</main>
</body>
</html>