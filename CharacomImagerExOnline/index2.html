<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8" />
	<title>CharacomImager Ex Online</title>
	<!-- Bootstrap用CSSの読み込み -->
	<!-- Bootstrap用JavaScriptの読み込み -->
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
	<link rel="stylesheet" href="css/bootstrap-treeview.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/drawer/3.2.2/css/drawer.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
	<script src='js/bootstrap-treeview.js'></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/iScroll/5.2.0/iscroll.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/drawer/3.2.2/js/drawer.min.js"></script>
	<script src='js/image-effect.js'></script>
	<script src='js/main-tab.js'></script>
	<script src='js/main-treeview.js'></script>
	<script src='js/main-sideview.js'></script>
	<script src='js/main.js'></script>
	<!--
	<script src="https://kit.fontawesome.com/a3cb7c4067.js" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	-->
	<style>
		.canvas-wrapper {
			position: relative;
		}
	
		.canvas-wrapper canvas {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			overflow: auto;
		}
	
		.rightSidePanel {
			height: 100%;
		}

		.navbar-light .drawer-toggler .drawer-drawer-hamburger {
    		border-color: rgba(0,0,0,0);
		}
	</style>
  <script>
	function activeTab( tabid ){
		$('.nav-tabs a[href="#' + tabid + '"]').tab( 'show' );
	}

    
	function getTree() {
  		// Some logic to retrieve, or generate tree structure
  		return ProjectTree;
	}

	function UpdateTree()
	{
		//$('#tree').treeview('remove');
		console.log(getTree());
		var www_test_tree = [
			{
				text: "Parent 1",
				nodes: [
					{
						text: "Child 1",
						icon: 'bi bi-images',
						nodes: [
							{
								text: "Grandchild 1",
								icon: 'bi bi-image'
							},
							{
								text: "Grandchild 2",
								icon: 'bi bi-image'
							}
						]
					},
					{
						text: "Child 2",
						icon: 'bi bi-images'
					}
				]
			},
			{
				text: "Parent 2"
			},
			{
				text: "Parent 3"
			},
			{
				text: "Parent 4"
			},
			{
				text: "Parent 5"
			}];
		//tt.treeview({data: ProjectTree});
		$('#tree').treeview({
			color: "#428bca",
			levels: 3,
			expandIcon: 'bi i-caret-right-fill',
			collapseIcon: 'bi bi-caret-down-fill',
			nodeIcon: 'bi bi-folder2-open',
			showBorder: false,
			data: www_test_tree
		});
		
		$('#tree').change();
		//$('#tree').treeview('enableAll', true);
		//$('#tree').treeview(true);
		//console.log(test2_tree);
		//console.log(ProjectTree);
		//console.log(JSON.stringify(ProjectTree));
		//console.log(test_tree);
		//console.log(JSON.stringify(test_tree));
	}
	function SizeChange(canvasName){
		var canvas = document.getElementById(canvasName);
		canvas.width = 700;
		canvas.height = 500;
		alert(canvasName);
	}

	
    var mamDraw=[];
    mamDraw.isMouseDown=false;
    mamDraw.position=[];
    mamDraw.position.x=0;
    mamDraw.position.y=0;
    mamDraw.position.px=0;
    mamDraw.position.py=0;

	let pointX = [];
	let pointY = [];

	var SideBarNum = 0;

	var nowID;
	
	function StopShake(event){
        mamDraw.isMouseDown=false;
        event.stopPropagation();
    }

    function onDown(event){
        var scaleWidth = mamDraw.canvas.clientWidth / mamDraw.canvas.width;
		var scaleHeight = mamDraw.canvas.clientHeight/ mamDraw.canvas.height;
		mamDraw.position.px=(event.touches[0].pageX-event.target.getBoundingClientRect().left-mamGetScrollPosition().x)/scaleWidth;
        mamDraw.position.py=(event.touches[0].pageY-event.target.getBoundingClientRect().top -mamGetScrollPosition().y)/scaleHeight;
        if(mamDraw.isMouseDown == true) drawLine();
        mamDraw.position.x=mamDraw.position.px;
        mamDraw.position.y=mamDraw.position.py;
		pointX.push(mamDraw.position.x);
		pointY.push(mamDraw.position.y);
        mamDraw.isMouseDown=true;
		event.preventDefault();
        event.stopPropagation();
    }
	function onMouseDown(event){
        var scaleWidth = mamDraw.canvas.clientWidth / mamDraw.canvas.width;
		var scaleHeight = mamDraw.canvas.clientHeight/ mamDraw.canvas.height;
		mamDraw.position.px=(event.clientX-event.target.getBoundingClientRect().left)/scaleWidth;
        mamDraw.position.py=(event.clientY-event.target.getBoundingClientRect().top)/scaleHeight;
        if(mamDraw.isMouseDown == true) drawLine();
        mamDraw.position.x=mamDraw.position.px;
        mamDraw.position.y=mamDraw.position.py;
        pointX.push(mamDraw.position.x);
		pointY.push(mamDraw.position.y);
        mamDraw.isMouseDown=true;
        event.stopPropagation();
    }

    function onMove(event){
        if(mamDraw.isMouseDown){
			var scaleWidth = mamDraw.canvas.clientWidth / mamDraw.canvas.width;
			var scaleHeight = mamDraw.canvas.clientHeight/ mamDraw.canvas.height;
			mamDraw.position.px=(event.touches[0].pageX-event.target.getBoundingClientRect().left-mamGetScrollPosition().x)/scaleWidth;
        	mamDraw.position.py=(event.touches[0].pageY-event.target.getBoundingClientRect().top -mamGetScrollPosition().y)/scaleHeight;
        	drawLine();
			mamDraw.position.x=mamDraw.position.px;
        	mamDraw.position.y=mamDraw.position.py;
        	pointX.push(mamDraw.position.x);
			pointY.push(mamDraw.position.y);
			mamDraw.position.px=mamDraw.position.x;
			mamDraw.position.py=mamDraw.position.y;
			event.stopPropagation();
        }
    }
	function onMouseMove(event){
        if(mamDraw.isMouseDown){
			var scaleWidth = mamDraw.canvas.clientWidth / mamDraw.canvas.width;
			var scaleHeight = mamDraw.canvas.clientHeight/ mamDraw.canvas.height;
			mamDraw.position.px=(event.clientX-event.target.getBoundingClientRect().left)/scaleWidth;
        	mamDraw.position.py=(event.clientY-event.target.getBoundingClientRect().top)/scaleHeight;
        	drawLine();
			mamDraw.position.x=mamDraw.position.px;
        	mamDraw.position.y=mamDraw.position.py;
        	pointX.push(mamDraw.position.x);
			pointY.push(mamDraw.position.y);
			mamDraw.position.px=mamDraw.position.x;
			mamDraw.position.py=mamDraw.position.y;
			event.stopPropagation();
        }
    }
    function onUp(event){
        onMouseUp(event);
		//mamDraw.isMouseDown=false;
		//fillPath();
		//var rect = getRectangle(pointX, pointY);
		//var canvas = document.getElementById("src_cnvs_" + nowID);
		//var rect_canvas = document.getElementById("exr_cnvs_" + nowID);
		//var outImage = GetRectangleImage(canvas, mamDraw.canvas, rect_canvas, rect);
		//createSideCanvas(outImage);
		//pointX = [];
		//pointY = [];
		//event.stopPropagation();
    }
    
    
    function onMouseUp(event){
        mamDraw.isMouseDown=false;
		fillPath();
		var rect = getRectangle(pointX, pointY);
		var canvas = document.getElementById("src_cnvs_" + ProjectObj[nowProjectID].nodes[nowImageID].name);
		var rect_canvas = document.getElementById("exr_cnvs_" + ProjectObj[nowProjectID].nodes[nowImageID].name);
		var outImage = GetRectangleImage(canvas, mamDraw.canvas, rect_canvas, rect);
		var charaID = add_NewChara(outImage);
		createSideCanvas(charaID, outImage);
		
		pointX = [];
		pointY = [];
		event.stopPropagation();
    }
    function drawLine(){
        var scaleWidth = mamDraw.canvas.clientWidth / mamDraw.canvas.width;
		var scaleHeight = mamDraw.canvas.clientHeight/ mamDraw.canvas.height;
		mamDraw.context.strokeStyle="#000000";
		mamDraw.context.setLineDash([2, 2]);
        mamDraw.context.lineWidth=2 / scaleWidth;
        mamDraw.context.lineJoin="round";
        mamDraw.context.lineCap="round";
        mamDraw.context.beginPath();
        mamDraw.context.moveTo(mamDraw.position.px,mamDraw.position.py);
        mamDraw.context.lineTo(mamDraw.position.x,mamDraw.position.y);
        mamDraw.context.stroke();
    }
	
	function fillPath(){
		mamDraw.context.beginPath();
		mamDraw.context.moveTo(pointX[0], pointY[0]);
		for(i=1; i<pointX.length; i++){
			mamDraw.context.lineTo(pointX[i], pointY[i]);
		}
		mamDraw.context.closePath();
		mamDraw.context.fillStyle = 'rgb(0, 0, 255)';
		mamDraw.context.fill();
	}
	
	function mamGetScrollPosition() {
        return {
        "x":document.documentElement.scrollLeft || document.body.scrollLeft,
        "y":document.documentElement.scrollTop  || document.body.scrollTop
        };
    }

	
	window.onload = function(){
		init_ProjectObj("No Name Project...");
		/**
		add_NewImage("NewImage desu", "");
		add_NewChara("NewChara 1", "");
		add_NewChara("NewChara 2", "");
		add_NewChara("NewChara 3", "");
		console.log(ProjectObj);
		***/
		$('#tree').change();
	}
    </script>
    
</head>
<body id='main-body' class="drawer drawer--left">
  <!-- メインメニュー -->
  <nav class="navbar navbar-expand-sm navbar-light bg-light">
	<div class="container-fluid">
	  <a class="navbar-brand" href="#">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CharacomEx Online</a>
	  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
		<span class="navbar-toggler-icon"></span>
	  </button>
	  <div class="collapse navbar-collapse" id="navbarNav">
		<ul class="navbar-nav">
		  <li class="nav-item dropdown">
			<a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
				ファイル
			</a>
			<ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
				<li><a class="dropdown-item" href="#">新しい資料を作成</a></li>
                <li><a class="dropdown-item" href="javascript:LoadImageFile('cnvs');">
					<label>
						画像を読み込む
						<!-- <input type="file" id="file" style="display: none;" onchange="LoadImageFile(this.files, 'cnvs', 'pTab1', 'tab1', 'photo1')"> -->
						<input type="file" id="file" style="display: none;" onchange="LoadImageFile(this.files, 'tab-root', 'tabpage-root')">
					</label>
				</a></li>
				<li><a class="dropdown-item" href="javascript:NodeSelect('aaa');">
					<label>
						画像をぼかす？？
					</label>
				</a></li>
                <li><a class="dropdown-item" href="javascript:SizeChange('cnvs');">閉じる</a></li>
                <li><a class="dropdown-item" href="#">終了</a></li>
				<li><a class="dropdown-item" href="#">Action</a></li>
				<li><a class="dropdown-item" href="#">Another action</a></li>
				<li><a class="dropdown-item" href="#">Something else here</a></li>
			</ul>
		  </li>
		</ul>
	  </div>
	</div><!-- /.container-fluid -->
  </nav>
  <!-- Drawer Menu -->
	<header role="banner">
		<button type="button" class="drawer-toggle drawer-hamburger">
		  <span class="sr-only">toggle navigation</span>
		  <span class="drawer-hamburger-icon"></span>
		</button>
		<nav class="drawer-nav" role="navigation">
		  <ul class="drawer-menu">
			<li><a class="drawer-brand">DrawrMenu</a></li>
			<li>
				<div class="btn-group-vertical" role="group" aria-label="垂直ラジオ切替ボタングループ">
					<input type="radio" class="btn-check" name="vbtn-radio" id="dm-sci" autocomplete="off" checked onclick="OnOffDrawerMenu();">
					<label class="btn btn-outline-danger" for="dm-sci">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-scissors" viewBox="0 0 16 16">
							<path d="M3.5 3.5c-.614-.884-.074-1.962.858-2.5L8 7.226 11.642 1c.932.538 1.472 1.616.858 2.5L8.81 8.61l1.556 2.661a2.5 2.5 0 1 1-.794.637L8 9.73l-1.572 2.177a2.5 2.5 0 1 1-.794-.637L7.19 8.61 3.5 3.5zm2.5 10a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0zm7 0a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0z"/>
						</svg>
						切り出し
					</label>
					<input type="radio" class="btn-check" name="vbtn-radio" id="dm-pen" autocomplete="off" onclick="OnOffDrawerMenu();">
					<label class="btn btn-outline-danger" for="dm-pen">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
							<path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
						</svg>
						書き足し
					</label>

					<input type="radio" class="btn-check" name="vbtn-radio" id="dm-era" autocomplete="off" onclick="OnOffDrawerMenu();">
					<label class="btn btn-outline-danger" for="dm-era">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eraser-fill" viewBox="0 0 16 16">
							<path d="M8.086 2.207a2 2 0 0 1 2.828 0l3.879 3.879a2 2 0 0 1 0 2.828l-5.5 5.5A2 2 0 0 1 7.879 15H5.12a2 2 0 0 1-1.414-.586l-2.5-2.5a2 2 0 0 1 0-2.828l6.879-6.879zm.66 11.34L3.453 8.254 1.914 9.793a1 1 0 0 0 0 1.414l2.5 2.5a1 1 0 0 0 .707.293H7.88a1 1 0 0 0 .707-.293l.16-.16z"/>
						  </svg>
						  消しゴム
					</label>
				</div>
			</li>
		  </ul>
		</nav>
	</header>

  <main class="p-3">
	<div class="row">
		<div class="col-2">
			<!-- プロジェクトツリー -->
			<div id="tree"></div>
		</div>
		<div class="col-7">
			<!-- タブナビ部分 -->
			<div class="nav nav-tabs" id="tab-root" role="tablist">
			</div>
			
			<!-- パネル部分 -->
			<div id="tabpage-root" class="tab-content">
			</div>
		</div>
		<div id='rightSide' class="col-3 overflow-auto">
			<!-- サイドバー文字一覧 -->
		</div>
	</main>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
	<script>
		//$('#tree').on('nodeSelected', SelectNode);
		$('#tree').change(function(){
			$('#tree').treeview({
          		color: "#428bca",
				levels: 5,
				expandIcon: 'bi bi-caret-right-fill',
				collapseIcon: 'bi bi-caret-down-fill',
				nodeIcon: 'bi bi-folder2-open',
				showBorder: false,
				onNodeSelected: SelectNode,
				data: ProjectObj
        	});
		});
		$('#tree').change();
    	
		//change tab (nav tab)
		$(document).on('shown.bs.tab', 'a[data-toggle="tab"]', function (e) {
    		console.log("active tab = " + e.target.id);
			var node;
			node = NodeSelect(e.target.id.substr(4));
			console.log(node);
			if(node != null){
				if(node.level == "image"){
					nowProjectID = node.projectID;
					nowImageID = node.id;
					addListener("tmp_cnvs_" + e.target.id.substr(4));
					deleteAllSideCanvas('rightSide');
					//console.log("level = image");
				}
				if(node.level == "chara"){
					//console.log("level = chara");
				}
				//console.log("checkNODE = " + node.name + "," + node.level);
			}
			//addListener("tmp_cnvs_" + e.target.id.substr(4));
		});

		$(document).ready(function() {
  			$('.drawer').drawer();
		});

	</script>
</body>
</html>