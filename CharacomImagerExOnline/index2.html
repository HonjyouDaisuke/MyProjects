<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8" />
	<title>CharacomImager Ex Online</title>
	<!-- Bootstrap用CSSの読み込み -->
	<!-- Bootstrap用JavaScriptの読み込み -->
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
	<link rel="stylesheet" href="css/bootstrap-treeview.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
	<script src='js/bootstrap-treeview.js'></script>
	<script src='js/image-effect.js'></script>
	<script src='js/main-tab.js'></script>
	<script src='js/main-treeview.js'></script>
	<script src='js/main.js'></script>
	<!--
	<script src="https://kit.fontawesome.com/a3cb7c4067.js" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	-->
	<style>
		.canvas-wrapper{
			position: relative;
		}
		.canvas-wrapper canvas{
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			overflow: auto;
		}

		.rightSideTanel{
			height: 100%;
		}
	</style>
  <script>
	function activeTab( tabid ){
		$('.nav-tabs a[href="#' + tabid + '"]').tab( 'show' );
	}

    
	function getTree() {
  		// Some logic to retrieve, or generate tree structure
  		return ProjectTree;
	}

	function UpdateTree()
	{
		//$('#tree').treeview('remove');
		console.log(getTree());
		var www_test_tree = [
			{
				text: "Parent 1",
				nodes: [
					{
						text: "Child 1",
						icon: 'bi bi-images',
						nodes: [
							{
								text: "Grandchild 1",
								icon: 'bi bi-image'
							},
							{
								text: "Grandchild 2",
								icon: 'bi bi-image'
							}
						]
					},
					{
						text: "Child 2",
						icon: 'bi bi-images'
					}
				]
			},
			{
				text: "Parent 2"
			},
			{
				text: "Parent 3"
			},
			{
				text: "Parent 4"
			},
			{
				text: "Parent 5"
			}];
		//tt.treeview({data: ProjectTree});
		$('#tree').treeview({
			color: "#428bca",
			levels: 3,
			expandIcon: 'bi i-caret-right-fill',
			collapseIcon: 'bi bi-caret-down-fill',
			nodeIcon: 'bi bi-folder2-open',
			showBorder: false,
			data: www_test_tree
		});
		
		$('#tree').change();
		//$('#tree').treeview('enableAll', true);
		//$('#tree').treeview(true);
		//console.log(test2_tree);
		//console.log(ProjectTree);
		//console.log(JSON.stringify(ProjectTree));
		//console.log(test_tree);
		//console.log(JSON.stringify(test_tree));
	}
	function SizeChange(canvasName){
		var canvas = document.getElementById(canvasName);
		canvas.width = 700;
		canvas.height = 500;
		alert(canvasName);
	}

	
    var mamDraw=[];
    mamDraw.isMouseDown=false;
    mamDraw.position=[];
    mamDraw.position.x=0;
    mamDraw.position.y=0;
    mamDraw.position.px=0;
    mamDraw.position.py=0;

	let pointX = [];
	let pointY = [];

	var SideBarNum = 0;

	var nowID;
	
	function StopShake(event){
        mamDraw.isMouseDown=false;
        event.stopPropagation();
    }

    function onDown(event){
        var scaleWidth = mamDraw.canvas.clientWidth / mamDraw.canvas.width;
		var scaleHeight = mamDraw.canvas.clientHeight/ mamDraw.canvas.height;
		mamDraw.position.px=(event.touches[0].pageX-event.target.getBoundingClientRect().left-mamGetScrollPosition().x)/scaleWidth;
        mamDraw.position.py=(event.touches[0].pageY-event.target.getBoundingClientRect().top -mamGetScrollPosition().y)/scaleHeight;
        if(mamDraw.isMouseDown == true) drawLine();
        mamDraw.position.x=mamDraw.position.px;
        mamDraw.position.y=mamDraw.position.py;
		pointX.push(mamDraw.position.x);
		pointY.push(mamDraw.position.y);
        mamDraw.isMouseDown=true;
		event.preventDefault();
        event.stopPropagation();
    }
	function onMouseDown(event){
        var scaleWidth = mamDraw.canvas.clientWidth / mamDraw.canvas.width;
		var scaleHeight = mamDraw.canvas.clientHeight/ mamDraw.canvas.height;
		mamDraw.position.px=(event.clientX-event.target.getBoundingClientRect().left)/scaleWidth;
        mamDraw.position.py=(event.clientY-event.target.getBoundingClientRect().top)/scaleHeight;
        if(mamDraw.isMouseDown == true) drawLine();
        mamDraw.position.x=mamDraw.position.px;
        mamDraw.position.y=mamDraw.position.py;
        pointX.push(mamDraw.position.x);
		pointY.push(mamDraw.position.y);
        mamDraw.isMouseDown=true;
        event.stopPropagation();
    }

    function onMove(event){
        if(mamDraw.isMouseDown){
			var scaleWidth = mamDraw.canvas.clientWidth / mamDraw.canvas.width;
			var scaleHeight = mamDraw.canvas.clientHeight/ mamDraw.canvas.height;
			mamDraw.position.px=(event.touches[0].pageX-event.target.getBoundingClientRect().left-mamGetScrollPosition().x)/scaleWidth;
        	mamDraw.position.py=(event.touches[0].pageY-event.target.getBoundingClientRect().top -mamGetScrollPosition().y)/scaleHeight;
        	drawLine();
			mamDraw.position.x=mamDraw.position.px;
        	mamDraw.position.y=mamDraw.position.py;
        	pointX.push(mamDraw.position.x);
			pointY.push(mamDraw.position.y);
			mamDraw.position.px=mamDraw.position.x;
			mamDraw.position.py=mamDraw.position.y;
			event.stopPropagation();
        }
    }
	function onMouseMove(event){
        if(mamDraw.isMouseDown){
			var scaleWidth = mamDraw.canvas.clientWidth / mamDraw.canvas.width;
			var scaleHeight = mamDraw.canvas.clientHeight/ mamDraw.canvas.height;
			mamDraw.position.px=(event.clientX-event.target.getBoundingClientRect().left)/scaleWidth;
        	mamDraw.position.py=(event.clientY-event.target.getBoundingClientRect().top)/scaleHeight;
        	drawLine();
			mamDraw.position.x=mamDraw.position.px;
        	mamDraw.position.y=mamDraw.position.py;
        	pointX.push(mamDraw.position.x);
			pointY.push(mamDraw.position.y);
			mamDraw.position.px=mamDraw.position.x;
			mamDraw.position.py=mamDraw.position.y;
			event.stopPropagation();
        }
    }
    function onUp(event){
        onMouseUp(event);
		//mamDraw.isMouseDown=false;
		//fillPath();
		//var rect = getRectangle(pointX, pointY);
		//var canvas = document.getElementById("src_cnvs_" + nowID);
		//var rect_canvas = document.getElementById("exr_cnvs_" + nowID);
		//var outImage = GetRectangleImage(canvas, mamDraw.canvas, rect_canvas, rect);
		//createSideCanvas(outImage);
		//pointX = [];
		//pointY = [];
		//event.stopPropagation();
    }
    
    function createSideCanvas(outImage){
		var sideCanvasID = CreateCanvas();
		var canvas_tmp = document.getElementById(sideCanvasID); 
		var ctx_tmp = canvas_tmp.getContext('2d');
		canvas_tmp.height = outImage.height;
		canvas_tmp.width = outImage.width;
		canvas_tmp.style.width = '30%';
		ctx_tmp.putImageData(outImage, 0, 0); 
	}
    function onMouseUp(event){
        mamDraw.isMouseDown=false;
		fillPath();
		var rect = getRectangle(pointX, pointY);
		var canvas = document.getElementById("src_cnvs_" + nowID);
		var rect_canvas = document.getElementById("exr_cnvs_" + nowID);
		var outImage = GetRectangleImage(canvas, mamDraw.canvas, rect_canvas, rect);
		createSideCanvas(outImage);
		add_NewChara(nowID, outImage);
		
		pointX = [];
		pointY = [];
		event.stopPropagation();
    }
    function drawLine(){
        var scaleWidth = mamDraw.canvas.clientWidth / mamDraw.canvas.width;
		var scaleHeight = mamDraw.canvas.clientHeight/ mamDraw.canvas.height;
		mamDraw.context.strokeStyle="#000000";
		mamDraw.context.setLineDash([2, 2]);
        mamDraw.context.lineWidth=2 / scaleWidth;
        mamDraw.context.lineJoin="round";
        mamDraw.context.lineCap="round";
        mamDraw.context.beginPath();
        mamDraw.context.moveTo(mamDraw.position.px,mamDraw.position.py);
        mamDraw.context.lineTo(mamDraw.position.x,mamDraw.position.y);
        mamDraw.context.stroke();
    }

	function SideBarDblClick(e){
		//console.log(e.target.id);
		// get imageData from SideCanvas
		var cnvs = document.getElementById(e.target.id);
		var ctx = cnvs.getContext('2d');
		var img = ctx.getImageData(0, 0, cnvs.width, cnvs.height);
		//create charactor tabs
		createNewTab_CharaImage('tab-root', 'tabpage-root', e.target.id, img);
	}
	// Create Canvas
	function CreateCanvas(){
		var new_canvas = document.createElement('canvas');
		var strCanvasID = "new_canvas" + SideBarNum.toString();
		new_canvas.id = strCanvasID;
		new_canvas.style.width = "100%";
		new_canvas.style.border = "1px";
		new_canvas.style.solid = "#aaa";
		new_canvas.style = "width:'100%' border:1px solid #aaa";
		new_canvas.addEventListener('dblclick', SideBarDblClick, false);
		// <canvas id="chara" style="border:1px solid #aaa" class="img-fluid"></canvas>
		var side_bar = document.getElementById('rightSide');
		var thum_div = document.createElement('div');
		thum_div.className = "thumbnail";
		thum_div.appendChild(new_canvas);
		side_bar.appendChild(thum_div);
		
		SideBarNum++;

		/***
		var node = [];
		node.text = tab.textContent;
		node.icon = "bi bi-images";
		node.nodes = [];
		ProjectTree[0].nodes.push(node);
		**/
		// set treeview
		//var node = {};
		//node.text = strCanvasID;
		//node.icon = "bi bi-image";

		//var charaNode1 = {};
		//charaNode1.text = "myChara1";
		//charaNode1.icon = "bi bi-image";

		//var charaNode2 = {};
		//charaNode2.text = "myChara2";
		//charaNode2.icon = "bi bi-image";

		//ProjectTree[0].nodes[0].nodes.push(node);
		//ProjectTree[0].nodes[0].nodes.push(charaNode1);
		//ProjectTree[0].nodes[0].nodes.push(charaNode2);

		//$('#tree').change();
		return(strCanvasID);
	}

	
	function fillPath(){
		mamDraw.context.beginPath();
		mamDraw.context.moveTo(pointX[0], pointY[0]);
		for(i=1; i<pointX.length; i++){
			mamDraw.context.lineTo(pointX[i], pointY[i]);
		}
		mamDraw.context.closePath();
		mamDraw.context.fillStyle = 'rgb(0, 0, 255)';
		mamDraw.context.fill();
	}
	
	function mamGetScrollPosition() {
        return {
        "x":document.documentElement.scrollLeft || document.body.scrollLeft,
        "y":document.documentElement.scrollTop  || document.body.scrollTop
        };
    }

	function new_node()
	{
		var pronode = {};
		pronode.text = "tab_from menu";
		pronode.icon = "bi bi-images";
		ProjectTree.push(pronode);
		$('#tree').change();
		/***
		$('#tree').treeview({
			color: "#428bca",
			levels: 5,
			expandIcon: 'bi i-caret-right-fill',
			collapseIcon: 'bi bi-caret-down-fill',
			nodeIcon: 'bi bi-folder2-open',
			showBorder: false,
			data: test_tree
		});
		***/
	}

	window.onload = function(){
		init_ProjectObj("No Name Project...");
		/**
		add_NewImage("NewImage desu", "");
		add_NewChara("NewChara 1", "");
		add_NewChara("NewChara 2", "");
		add_NewChara("NewChara 3", "");
		console.log(ProjectObj);
		***/
		$('#tree').change();
	}
    </script>
    
</head>
<body>
  <!-- メインメニュー -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
	<div class="container-fluid">
	  <a class="navbar-brand" href="#">CharacomEx Online</a>
	  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
		<span class="navbar-toggler-icon"></span>
	  </button>
	  <div class="collapse navbar-collapse" id="navbarNav">
		<ul class="navbar-nav">
		  <li class="nav-item dropdown">
			<a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
				ファイル
			</a>
			<ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
				<li><a class="dropdown-item" href="#">新しい資料を作成</a></li>
                <li><a class="dropdown-item" href="javascript:LoadImageFile('cnvs');">
					<label>
						画像を読み込む
						<!-- <input type="file" id="file" style="display: none;" onchange="LoadImageFile(this.files, 'cnvs', 'pTab1', 'tab1', 'photo1')"> -->
						<input type="file" id="file" style="display: none;" onchange="LoadImageFile(this.files, 'tab-root', 'tabpage-root')">
					</label>
				</a></li>
				<li><a class="dropdown-item" href="javascript:new_node();">
					<label>
						画像をぼかす？？
					</label>
				</a></li>
                <li><a class="dropdown-item" href="javascript:SizeChange('cnvs');">閉じる</a></li>
                <li><a class="dropdown-item" href="#">終了</a></li>
				<li><a class="dropdown-item" href="#">Action</a></li>
				<li><a class="dropdown-item" href="#">Another action</a></li>
				<li><a class="dropdown-item" href="#">Something else here</a></li>
			</ul>
		  </li>
		  <!--
		  <li class="nav-item">
			<a class="nav-link" href="#">Features</a>
		  </li>
		  <li class="nav-item">
			<a class="nav-link" href="#">Pricing</a>
		  </li>
		  <li class="nav-item dropdown">
			<a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
			  Dropdown link
			</a>
			<ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
			  <li><a class="dropdown-item" href="#">Action</a></li>
			  <li><a class="dropdown-item" href="#">Another action</a></li>
			  <li><a class="dropdown-item" href="#">Something else here</a></li>
			</ul>
		  </li>
		  -->
		</ul>
	  </div>
	</div><!-- /.container-fluid -->
  </nav>

  <main class="p-3">
	<div class="row">
		<div class="col-2">
			<div id="tree"></div>
		</div>
		<!--
		<nav class="col-1">
			<ul class="nav nav-pills nav-stacked nav-inverse" data-spy="affix" data-offset-top="205">
				<li class="active"><a href="#section1">セクション 1</a></li>
				<li><a href="#section2">セクション 2</a></li>
				<li><a href="#section3">セクション 3</a></li>
			</ul>
		</nav>
		-->
		<div class="col-7">
			<!-- <ul id="tab-root" class="nav nav-tabs nav-inverse"> -->
			<div class="nav nav-tabs" id="tab-root" role="tablist">
				<!--
				<a class="nav-link" id="tab1" data-bs-toggle="tab" href="#photo1" role="tab" aria-controls="photo1" aria-selected="false">tab1</a>
				-->
			</div>
			
			<!-- パネル部分 -->
			<div id="tabpage-root" class="tab-content">
				<!--	
				<div id="photo1" class="tab-pane">
					<div class="canvas-wrapper">
						<canvas id="cnvs" style="border:1px solid #aaa" class="img-fluid"></canvas>
						<canvas id="ex_rect" style="border:1px solid #aaa" class="img-fluid"></canvas>
						<canvas id="tmp" style="border:1px solid #aaa" class="img-fluid"></canvas>
					</div>	
				</div>
				-->
			</div>
			<!--
			<ul id="tab-root" class="nav nav-tabs">
				<li class="nav-item"><a href="#" class="nav-link active" aria-current="page">アクティブ</a></li>
				<li class="nav-item"><a href="#" class="nav-link">リンク1</a></li>
				<li class="nav-item"><a href="#" class="nav-link">リンク2</a></li>
				<li class="nav-item"><a href="#" class="nav-link disabled" tabindex="-1" aria-disabled="true">無効</a></li>
				
				<li id="pTab1" class="nav-item"> <a id="tab1" href="#photo1" class="nav-link active" data-toggle="tab">タブ1 &nbsp;<span class="close">×</span></a> </li>
				<li class="nav-item"> <a href="#photo2" class="nav-link" data-toggle="tab">タブ2 &nbsp;<span class="close">×</span></a> </li>
				<li class="nav-item"> <a href="#photo3" class="nav-link" data-toggle="tab">タブ3 &nbsp;<span class="close">×</span></a> </li>
				<li class="nav-item"> <a href="#photo4" class="nav-link" data-toggle="tab">タブ4 &nbsp;<span class="close">×</span></a> </li>
				
			</ul>
			-->
			<!-- 写真部分 -->
			<!--
			<div id="tabpage-root" class="tab-content">
				<div id="photo1" class="tab-pane">
					<div class="canvas-wrapper">
						<canvas id="cnvs" style="border:1px solid #aaa" class="img-fluid"></canvas>
						<canvas id="ex_rect" style="border:1px solid #aaa" class="img-fluid"></canvas>
						<canvas id="tmp" style="border:1px solid #aaa" class="img-fluid"></canvas>
						</div>	
					</div>
					
					<div id="photo2" class="tab-pane"> タブコントロールです。リポジトリチェック </div>
					<div id="photo3" class="tab-pane"> こちらも変えてみます。 </div>
					<div id="photo4" class="tab-pane"> ここには写真４が入ります。 </div>
					
				</div>	
			</div>
			-->
		</div>
		<div id='rightSide' class="overflow-auto col-3">
			ImageFiles<br>
		</div>
		<!-- 4個分のタブ -->
	</main>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
	<script>
		//$('#tree').on('nodeSelected', SelectNode);
		$('#tree').change(function(){
			$('#tree').treeview({
          		color: "#428bca",
				levels: 5,
				expandIcon: 'bi bi-caret-right-fill',
				collapseIcon: 'bi bi-caret-down-fill',
				nodeIcon: 'bi bi-folder2-open',
				showBorder: false,
				onNodeSelected: SelectNode,
				data: ProjectObj
        	});
		});
		$('#tree').change();
    	
	</script>
</body>
</html>